# Смарт-контракт cyber.worker

### Параметры контракта

Параметры, прописанные в коде:
```cpp
constexpr int witness_count = 21;
constexpr int witness_count_51 = witness_count / 2 + 1;
constexpr int witness_count_75 = witness_count * 3 / 4 + 1;

constexpr unsigned payout_expiration_sec  = 3*60*60;
constexpr unsigned payout_sender_id = 1;
constexpr size_t max_payed_tspecs_per_action = 10;
```

# Комментарии и посты

### Идентификатор поста или комментария

При создании поста или комментария клиентское приложение должно передать его уникальный идентификатор (тип `comment_id_t`).
Идентификатор может быть целым беззнаковым 64-битным числом, начиная от 0 включительно.

Предполагается, что в приложении будет своя таблица, в которую при создании каждого комментария добавляется запись, используемая для хранения неконсенсусной информации по комментарию (прежде всего, его текста). Отправка операций-действий на изменение и удаление комментария также жёстко связаны с соответствующими действиями с записью таблице.

Тогда возможны, например, такие варианты формирования идентификаторов приложением:
- Уникальный автоинкрементный первичный ключ в этой таблице, который будет также идентификатором записи для приложения;
- То же самое, но ключ не автоинкрементный, а содержащий первые 64 бита от хеша по адресу (ЧПУ-permlink), который будет иметь данный комментарий в приложении.

### Операция-действие addcomment
Операция-действие `addcomment` позволяет аккаунту создать пост с текстом Предложения, ТЗ или Отчёта, или же комментарий. Данная операция имеет следующий вид:  
```cpp
[[eosio::action]] void addcomment(
    comment_id_t comment_id,
    name author,
    std::optional<comment_id_t> parent_id,
    const string& text
);
```
Параметры:  
`comment_id` — идентификатор для публикуемого поста или комментария (см. раздел Идентификатор комментария);   
`author` — имя аккаунта, публикующего комментарий;  
`parent_id` — идентификатор поста или комментария, к которому публикуется комментарий (если публикуется пост, то оставить пустым);   
`text` — строка с текстом поста.
  
Для выполнения данной операции-действия требуются права аккаунта `author`.

### Операция-действие editcomment
Операция-действие `editcomment` позволяет автору поста или комментария изменять его. Данная операция имеет следующий вид:  
```cpp
[[eosio::action]] void editcomment(
    comment_id_t comment_id,
    const string& text
);
```

### Операция-действие delcomment
Операция-действие `delcomment` позволяет автору поста или комментария удалять его. Данная операция имеет следующий вид:  
```cpp
[[eosio::action]] void delcomment(
    comment_id_t comment_id
);
```

Удаление поста или комментария возможно только в том случае, если под ним нет комментариев, а также к нему не создано Предложение, ТЗ или Отчёт.

## Предложения

### Операция-действие addpropos
Операция-действие `addpropos` позволяет автору поста создавать Предложение на его основе. Данная операция имеет следующий вид:  
```cpp
[[eosio::action]] void addpropos(
    comment_id_t proposal_id,
    name author,
    uint8_t type
);
```
Параметры:  
`proposal_id` — идентификатор поста (служит также идентификатором Предложения);   
`author` — имя аккаунта, публикующего Предложение;  
`type` — тип публикуемого Предложения, TODO вынести отдельным перечислением
TYPE_TASK = 0 для пропозала по которому предполагается работать
TYPE_DONE = 1 с уже готовой работой
  
Для выполнения данной операции нужны права автора поста.
Комментарии (не корневые) не подходят.
Если пропозал на данном посте уже создан, то второй создать нельзя.

### Операция-действие editpropos
TODO
```cpp
[[eosio::action]] void editpropos(
     comment_id_t proposal_id,
     uint8_t type
);
```

Редактировать пропозал возможно только до тех пор, пока для него нет ни одного ТЗ.

### Операция-действие delpropos
TODO
```cpp
[[eosio::action]] void delpropos(
    comment_id_t proposal_id
);
```

Удалять Предложение возможно только до тех пор, пока для него нет ни одного ТЗ.
# Подача технических заданий

### Операция-действие addtspec
Операция-действие `addtspec` позволяет автору поста публиковать ТЗ для Предложения на основе этого поста. Данная операция имеет следующий вид:  
```cpp
[[eosio::action]] void addtspec(
    comment_id_t tspec_id,
    name author,
    comment_id_t proposal_id,
    const tspec_data_t& tspec,
    std::optional<name> worker
);
```
Параметры:
`tspec_id` - идентификатор поста.
`author` - имя автора поста.
`proposal_id` - идентификатор Предложения, для которого публикуется ТЗ.
`tspec` - параметры публикуемого ТЗ, TODO вынести отдельно объявлением:
- asset specification_cost; сумма вознаграждения автору ТЗ за ТЗ;
- asset development_cost; сумма вознаграждения воркеру;
- int16_t payments_count; кол-во платежей, на которое разбиваются обе суммы;
- uint32_t payments_interval; интервал платежей в секундах. Первый платеж происходит после интервала.
`worker` - аккаунт Воркера, назначаемый на ТЗ (если Предложение не TYPE_DONE, то назначать Воркера при создании ТЗ необязательно и можно сделать это с помощью `startwork`).

### Операция-действие edittspec
Операция-действие `edittspec` позволяет автору ТЗ редактировать его или менять Воркера (если Предложение не TYPE_DONE). Данная операция имеет следующий вид:  
```cpp
[[eosio::action]] void edittspec(
    comment_id_t tspec_id,
    const tspec_data_t& tspec,
    std::optional<name> worker
);
```
TODO

### Операция-действие deltspec
TODO
```cpp
[[eosio::action]] void deltspec(
    comment_id_t tspec_id
);
```
TODO

## Выбор валидаторами технического задания для реализации в рамках Предложения

### Операция-действие apprtspec
Позволяет валидатору подавать голос за ТЗ.
Если уже подан голос против, то он заменяется.
```cpp
[[eosio::action]] void apprtspec(
    comment_id_t tspec_id,
    name approver
);
```

TODO


### Операция-действие dapprtspec
Позволяет валидатору подавать голос против ТЗ.
Если уже подан голос за, то он заменяется.
```cpp
[[eosio::action]] void dapprtspec(
    comment_id_t tspec_id,
    name approver
);
```

TODO

### Операция-действие unapprtspec
Позволяет валидатору отменить поданный голос за ТЗ.
```cpp
[[eosio::action]] void unapprtspec(
    comment_id_t tspec_id,
    name approver
);
```

TODO

## Выполнение работы по ТЗ и публикация Отчёта

### Операция-действие startwork
Операция-действие `startwork` позволяет автору ТЗ назначать на него Воркера и запускать работу по ТЗ, если она ещё не запущена. Данная операция имеет следующий вид:  
```cpp
[[eosio::action]] void startwork(
    comment_id_t tspec_id,
    name worker
);
```
TODO

### Операция-действие cancelwork
Операция-действие `cancelwork` позволяет автору ТЗ или воркеру отказываться от работы, останавливая ее. Данная операция имеет следующий вид:  
```cpp
[[eosio::action]] void cancelwork(
    comment_id_t tspec_id,
    name initiator
);
```
Initiator имя аккаунта. Должно быть автором ТЗ или воркером.

Нужны права автора ТЗ или воркера.

### Операция-действие acceptwork
Операция-действие `acceptwork` позволяет автору ТЗ публиковать отчёт о выполненной работе. Данная операция имеет следующий вид:  
```cpp
[[eosio::action]] void acceptwork(
    comment_id_t tspec_id,
    comment_id_t result_comment_id
);
```
result_comment_id - идентификатор поста с Отчётом.

Требуются права автора ТЗ.
Пост с Отчётом должен быть постом, а не комментарием. То есть быть корневым.
Опубликованный отчёт отправляется на голосование валидаторов за или против него.

### Операция-действие unacceptwork
TODO
```cpp
[[eosio::action]] void unacceptwork(
    comment_id_t tspec_id
);
```

TODO

## Выплаты по ТЗ

### Операция-действие payout
Операция-действие `payout` делает выплаты по всем ТЗ, которые в этот момент должны получить выплаты. Данная операция имеет следующий вид:  
```cpp
[[eosio::action]] void payout(
    name ram_payer
);
```

Никакие права не требуются. Вызывается самим контрактом из эмиссии или любым пользователем вручную.
Пользователь ram_payer платит за транзакцию в случае, если кол-во ТЗ к выплате больше, чем параметр `max_payed_tspecs_per_action`.
При вызове из эмиссии ram_payer = сам контракт.
